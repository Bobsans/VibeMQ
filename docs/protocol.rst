=================
Протокол связи
=================

Это руководство описывает протокол обмена сообщениями VibeMQ.

.. contents:: Содержание
   :local:
   :depth: 2

Обзор
=====

VibeMQ использует TCP в качестве транспорта и JSON для сериализации сообщений. Протокол разработан для простоты и производительности.

Уровни протокола
================

.. code-block:: text

   ┌─────────────────────────────────────┐
   │  Прикладной уровень (JSON)          │
   ├─────────────────────────────────────┤
   │  Фрейминг (Length-prefix)           │
   ├─────────────────────────────────────┤
   │  Транспорт (TCP)                    │
   └─────────────────────────────────────┘

Фрейминг
========

Для разделения сообщений в TCP-потоке используется **length-prefix** подход:

.. code-block:: text

   [4 байта: длина тела в Big Endian uint32] [N байт: JSON-тело в UTF-8]

Формат длины
------------

Первые 4 байта каждого фрейма содержат длину тела сообщения в кодировке Big Endian:

.. code-block:: csharp

   // Чтение длины
   byte[] lengthBytes = await stream.ReadAsync(4);
   uint length = BitConverter.ToUInt32(lengthBytes.Reverse().ToArray(), 0);
   
   // Запись длины
   uint length = (uint)messageBytes.Length;
   byte[] lengthBytes = BitConverter.GetBytes(length).Reverse().ToArray();
   await stream.WriteAsync(lengthBytes);

Пример фрейма
-------------

.. code-block:: text

   Байты 0-3:   [0x00 0x00 0x00 0x5A]  ← Длина 90 байт
   Байты 4-93:  [{"id":"msg_123",...}]  ← JSON-сообщение

Формат сообщения
================

Базовая структура
-----------------

Все сообщения протокола имеют общую структуру:

.. code-block:: json

   {
     "id": "msg_123",
     "type": "publish",
     "queue": "notifications",
     "payload": {...},
     "headers": {...},
     "schemaVersion": "1.0"
   }

Поля сообщения
--------------

+-------------------+------------------+----------------------------------+
| Поле              | Тип              | Описание                         |
+===================+==================+==================================+
| ``id``            | string           | Уникальный идентификатор         │
+-------------------+------------------+----------------------------------+
| ``type``          | CommandType      | Тип команды                      │
+-------------------+------------------+----------------------------------+
| ``queue``         | string?          | Имя очереди                      │
+-------------------+------------------+----------------------------------+
| ``payload``       | JsonElement?     | Полезная нагрузка                │
+-------------------+------------------+----------------------------------+
| ``headers``       | object?          | Заголовки                        │
+-------------------+------------------+----------------------------------+
| ``schemaVersion`` | string           | Версия протокола (по умолчанию   │
|                   |                  | "1.0")                           │
+-------------------+------------------+----------------------------------+
| ``errorCode``     | string?          | Код ошибки (для Error)           │
+-------------------+------------------+----------------------------------+
| ``errorMessage``  | string?          | Сообщение об ошибке              │
+-------------------+------------------+----------------------------------+

Типы команд (CommandType)
=========================

.. code-block:: csharp

   public enum CommandType {
       // Управление соединением
       Connect = 0,
       ConnectAck = 1,
       Disconnect = 2,

       // Keep-alive
       Ping = 10,
       Pong = 11,

       // Pub/Sub
       Publish = 20,
       PublishAck = 21,
       Subscribe = 22,
       SubscribeAck = 23,
       Unsubscribe = 24,
       UnsubscribeAck = 25,
       Deliver = 26,

       // Подтверждение
       Ack = 30,

       // Управление очередями
       CreateQueue = 40,
       DeleteQueue = 41,
       QueueInfo = 42,
       ListQueues = 43,

       // Ошибки
       Error = 99,
   }

Описание команд
===============

Управление соединением
----------------------

Connect
~~~~~~~

**Направление:** Клиент → Сервер

**Описание:** Запрос на установление соединения.

.. code-block:: json

   {
     "id": "conn_123",
     "type": "connect",
     "headers": {
       "authToken": "my-secret-token",
       "clientVersion": "1.0.0"
     }
   }

ConnectAck
~~~~~~~~~~

**Направление:** Сервер → Клиент

**Описание:** Подтверждение соединения.

.. code-block:: json

   {
     "id": "conn_123",
     "type": "connectAck",
     "headers": {
       "serverVersion": "1.0.0",
       "connectionId": "srv_456"
     }
   }

Disconnect
~~~~~~~~~~

**Направление:** Клиент → Сервер

**Описание:** Запрос на завершение соединения.

.. code-block:: json

   {
     "id": "disc_123",
     "type": "disconnect"
   }

Keep-alive
----------

Ping
~~~~

**Направление:** Клиент → Сервер

**Описание:** Проверка активности соединения.

.. code-block:: json

   {
     "id": "ping_123",
     "type": "ping"
   }

Pong
~~~~

**Направление:** Сервер → Клиент

**Описание:** Ответ на Ping.

.. code-block:: json

   {
     "id": "ping_123",
     "type": "pong"
   }

Публикация/Подписка
-------------------

Publish
~~~~~~~

**Направление:** Клиент → Сервер

**Описание:** Публикация сообщения в очередь.

.. code-block:: json

   {
     "id": "msg_123",
     "type": "publish",
     "queue": "notifications",
     "payload": {
       "title": "Hello",
       "body": "World"
     },
     "headers": {
       "priority": "high",
       "correlationId": "corr_456",
       "timestamp": "2026-02-18T10:30:00Z"
     }
   }

PublishAck
~~~~~~~~~~

**Направление:** Сервер → Клиент

**Описание:** Подтверждение публикации.

.. code-block:: json

   {
     "id": "msg_123",
     "type": "publishAck",
     "headers": {
       "messageId": "msg_123",
       "queueName": "notifications"
     }
   }

Subscribe
~~~~~~~~~

**Направление:** Клиент → Сервер

**Описание:** Подписка на очередь.

.. code-block:: json

   {
     "id": "sub_123",
     "type": "subscribe",
     "queue": "notifications"
   }

SubscribeAck
~~~~~~~~~~~~

**Направление:** Сервер → Клиент

**Описание:** Подтверждение подписки.

.. code-block:: json

   {
     "id": "sub_123",
     "type": "subscribeAck",
     "headers": {
       "queueName": "notifications",
       "subscriptionId": "sub_123"
     }
   }

Unsubscribe
~~~~~~~~~~~

**Направление:** Клиент → Сервер

**Описание:** Отписка от очереди.

.. code-block:: json

   {
     "id": "unsub_123",
     "type": "unsubscribe",
     "queue": "notifications"
   }

UnsubscribeAck
~~~~~~~~~~~~~~

**Направление:** Сервер → Клиент

**Описание:** Подтверждение отписки.

.. code-block:: json

   {
     "id": "unsub_123",
     "type": "unsubscribeAck",
     "headers": {
       "queueName": "notifications"
     }
   }

Deliver
~~~~~~~

**Направление:** Сервер → Клиент

**Описание:** Доставка сообщения подписчику.

.. code-block:: json

   {
     "id": "msg_123",
     "type": "deliver",
     "queue": "notifications",
     "payload": {
       "title": "Hello",
       "body": "World"
     },
     "headers": {
       "priority": "high",
       "deliveryAttempts": "1"
     }
   }

Подтверждение
-------------

Ack
~~~

**Направление:** Клиент → Сервер

**Описание:** Подтверждение получения сообщения.

.. code-block:: json

   {
     "id": "ack_123",
     "type": "ack",
     "headers": {
       "messageId": "msg_123"
     }
   }

Управление очередями
--------------------

CreateQueue
~~~~~~~~~~~

**Направление:** Клиент → Сервер

**Описание:** Создание очереди.

.. code-block:: json

   {
     "id": "create_123",
     "type": "createQueue",
     "queue": "my-queue",
     "headers": {
       "deliveryMode": "RoundRobin",
       "maxQueueSize": "10000",
       "messageTtl": "3600000"
     }
   }

DeleteQueue
~~~~~~~~~~~

**Направление:** Клиент → Сервер

**Описание:** Удаление очереди.

.. code-block:: json

   {
     "id": "delete_123",
     "type": "deleteQueue",
     "queue": "my-queue"
   }

QueueInfo
~~~~~~~~~

**Направление:** Клиент → Сервер, Сервер → Клиент

**Описание:** Запрос/ответ информации об очереди.

**Запрос:**

.. code-block:: json

   {
     "id": "info_123",
     "type": "queueInfo",
     "queue": "my-queue"
   }

**Ответ:**

.. code-block:: json

   {
     "id": "info_123",
     "type": "queueInfo",
     "queue": "my-queue",
     "payload": {
       "name": "my-queue",
       "messageCount": 42,
       "subscriberCount": 3,
       "deliveryMode": "RoundRobin",
       "maxSize": 10000,
       "createdAt": "2026-02-18T10:00:00Z"
     }
   }

ListQueues
~~~~~~~~~~

**Направление:** Клиент → Сервер, Сервер → Клиент

**Описание:** Запрос/ответ списка очередей.

**Запрос:**

.. code-block:: json

   {
     "id": "list_123",
     "type": "listQueues"
   }

**Ответ:**

.. code-block:: json

   {
     "id": "list_123",
     "type": "listQueues",
     "payload": ["queue1", "queue2", "queue3"]
   }

Ошибки
------

Error
~~~~~

**Направление:** Сервер → Клиент

**Описание:** Сообщение об ошибке.

.. code-block:: json

   {
     "id": "err_123",
     "type": "error",
     "errorCode": "AUTH_FAILED",
     "errorMessage": "Invalid authentication token"
   }

Коды ошибок
~~~~~~~~~~~

+------------------------+----------------------------------+
| Код                    | Описание                         |
+========================+==================================+
| ``AUTH_FAILED``        | Ошибка аутентификации            |
+------------------------+----------------------------------+
| ``INVALID_MESSAGE``    | Неверный формат сообщения        |
+------------------------+----------------------------------+
| ``QUEUE_NOT_FOUND``    | Очередь не найдена               |
+------------------------+----------------------------------+
| ``QUEUE_EXISTS``       | Очередь уже существует           |
+------------------------+----------------------------------+
| ``RATE_LIMITED``       | Превышен лимит скорости          |
+------------------------+----------------------------------+
| ``SERVER_ERROR``       | Внутренняя ошибка сервера        |
+------------------------+----------------------------------+

Заголовки (Headers)
===================

Общие заголовки
---------------

+------------------------+----------------------------------+
| Заголовок              | Описание                         |
+========================+==================================+
| ``authToken``          | Токен аутентификации             |
+------------------------+----------------------------------+
| ``clientVersion``      | Версия клиента                   |
+------------------------+----------------------------------+
| ``serverVersion``      | Версия сервера                   |
+------------------------+----------------------------------+
| ``connectionId``       | Идентификатор соединения         |
+------------------------+----------------------------------+

Заголовки сообщений
-------------------

+------------------------+----------------------------------+
| Заголовок              | Описание                         |
+========================+==================================+
| ``priority``           | Приоритет (Low, Normal, High,    │
|                        │ Critical)                        |
+------------------------+----------------------------------+
| ``correlationId``      | ID для корреляции запросов       |
+------------------------+----------------------------------+
| ``timestamp``          | Время создания (ISO 8601)        |
+------------------------+----------------------------------+
| ``deliveryAttempts``   | Количество попыток доставки      |
+------------------------+----------------------------------+
| ``messageId``          | ID сообщения                     |
+------------------------+----------------------------------+
| ``queueName``          | Имя очереди                      |
+------------------------+----------------------------------+
| ``subscriptionId``     | ID подписки                      |
+------------------------+----------------------------------+

Заголовки очередей
------------------

+------------------------+----------------------------------+
| Заголовок              | Описание                         |
+========================+==================================+
| ``deliveryMode``       | Режим доставки                   |
+------------------------+----------------------------------+
| ``maxQueueSize``       | Максимальный размер              |
+------------------------+----------------------------------+
| ``messageTtl``         | TTL в миллисекундах              |
+------------------------+----------------------------------+
| ``enableDeadLetterQueue`` | Включить DLQ                  |
+------------------------+----------------------------------+
| ``maxRetryAttempts``   | Макс. попыток доставки           |
+------------------------+----------------------------------+

Примеры обмена
==============

Установка соединения
--------------------

.. code-block:: text

   Клиент → Сервер:
   {
     "id": "conn_001",
     "type": "connect",
     "headers": {
       "authToken": "my-token"
     }
   }

   Сервер → Клиент:
   {
     "id": "conn_001",
     "type": "connectAck",
     "headers": {
       "connectionId": "srv_100"
     }
   }

Публикация сообщения
--------------------

.. code-block:: text

   Клиент → Сервер:
   {
     "id": "msg_001",
     "type": "publish",
     "queue": "notifications",
     "payload": {
       "title": "Hello",
       "body": "World"
     }
   }

   Сервер → Клиент:
   {
     "id": "msg_001",
     "type": "publishAck",
     "headers": {
       "messageId": "msg_001",
       "queueName": "notifications"
     }
   }

Доставка сообщения
------------------

.. code-block:: text

   Сервер → Клиент:
   {
     "id": "msg_001",
     "type": "deliver",
     "queue": "notifications",
     "payload": {
       "title": "Hello",
       "body": "World"
     }
   }

   Клиент → Сервер:
   {
     "id": "ack_001",
     "type": "ack",
     "headers": {
       "messageId": "msg_001"
     }
   }

Keep-alive
----------

.. code-block:: text

   Клиент → Сервер:
   {
     "id": "ping_001",
     "type": "ping"
   }

   Сервер → Клиент:
   {
     "id": "ping_001",
     "type": "pong"
   }

Версии протокола
================

Текущая версия: **1.0**

+----------------+----------------------------------+
| Версия         | Изменения                        |
+================+==================================+
| 1.0            | Базовая версия                   |
+----------------+----------------------------------+

Следующие шаги
==============

- :doc:`architecture` — архитектура системы
- :doc:`features` — возможности VibeMQ
- :doc:`monitoring` — мониторинг
